This section is dedicated to describing the general concept of the new readout-system. 
The system was given the name \gls{theresa} and in the sections to follow  this name will be used to denote the new system.

First, a short overview of state of the art systems is given, including commercially available real-time oscilloscopes and the \gls{kapture}.
This system was developed at \gls{kit} (\gls{ipe}) specifically addressing the needs of \gls{thz} diagnostics at \gls{kara}.
The working principle of this system is explained in detail, as the new \gls{theresa} system is an evolution of the \gls{kapture} system. 

Then, the architecture of the \gls{theresa} system itself is described.

\section{State Of The Art Readout-Systems}

\subsection*{Real-Time Oscilloscopes}
Real-time oscilloscopes are defined by three key banner specifications: bandwidth, sample rate, and memory depth.
Some examples of currently commercially available oscilloscopes are listed in \autoref{tab:real_time_osc}.

\begin{table}[tbh]
	\caption[Real Time Oscilloscopes Examples]{Some example real-time oscilloscopes with (max.) key characteristics}
	\label{tab:real_time_osc}
	\centering
	\begin{tabularx}{\textwidth}{Xcccc}
		\toprule
		\textbf{Model}            & \textbf{Bandwidth} &         \textbf{Sample Rate}         &  \textbf{Memory Depth}  & \textbf{Acquisition time} \\ \midrule
		Keysight MXR608A          &    \SI{6}{\GHz}    & \SI{16}{\giga \sample \per \second}  & \SI{1.6}{\giga \sample} &  \SI{10}{\milli \second}  \\
		Tektronix DPO70000SX      &   \SI{70}{\GHz}    & \SI{200}{\giga \sample \per \second} &  \SI{1}{\giga \sample}  &  \SI{5}{\milli \second}   \\
		LeCroy LabMaster 10-100Zi &   \SI{65}{\GHz}    & \SI{160}{\giga \sample \per \second} & \SI{512}{\mega \sample} & \SI{3.2}{\milli \second}  \\ \bottomrule
	\end{tabularx}
\end{table}
%todo table 

\subsection{KAPTURE}
\Gls{kapture} (Karlsruhe Pulse Taking Ultra-Fast Readout Electronics) is a fast readout system developed at the \Gls{ipe} for \Gls{thz} diagnostics at \gls{kara}. It is designed to digitize the pulses generated by \Gls{thz} detectors at each revolution, only sampling the pulse shapes without the "empty" signal in between. The system is able to sample pulses with a \gls{fwhm} between a few tens to a hundred picoseconds with a minimal sample time of \SI{3}{\pico \second}. \cite{caselleKAP}

\subsubsection*{General Concept}
The system consists of two parts: the sampling front-end card and a \gls{fpga} readout card. In \autoref{fig:thz_chain} the setup for \gls{thz} radiation measurements with \gls{kapture} is shown. 

The incoming radiation is fed into a detector, which converts the incident photons into an electrical signal. 
This signal is then amplified in a wide-band \gls{lna}. 
A wideband lossless power splitter, developed at \gls{ipe}, splits the detector signal into four identical signals, which are then propagated to the sampling front-end card. 
The card consists of four parallel sampling channels with adjustable sampling time. 
Each channel contains a \gls{tha} and an ADC. 
This card is connected to a read-out card, which has two tasks: programming the components on the front-end card (\gls{fpga}-part) and sending the acquired data to a PC/\gls{daq} system \cite{caselle2014}.

\begin{figure}[tbh]
	\centering
	\includegraphics[width = \textwidth]{chap/03-currentStat/img/thzChain.tikz}
	\caption[THz measurement with KAPTURE]{\gls{thz} radiation measurement setup with \gls{kapture}(cf. \cite{caselle2014})}
	\label{fig:thz_chain}
\end{figure}

\paragraph{Analog Front-End}
Due to the high bandwidth nature of the detector signal, the analog front-end of the system has to be wideband as well to be able to sample the signal with picosecond resolution. 

The used \gls{lna} is based on a commercial GaAs \gls{mmic} which operates from DC to \SI{50}{\giga \hertz}. 
It is needed to compensate the insertion loss\footnote{\textit{Insertion loss} is the loss of signal power which occurs, when a signal passes through a component.} of the following power splitter stage. 
Classical power-splitters are not intrinsically wideband (\cite{caselle2014}). For that reason, an wideband power-splitter was developed at \gls{ipe} which fulfills the bandwidth requirements. 
The designed power-splitter works up to \SI{100}{\giga \hertz} with an insertion loss of \SI{8}{\decibel} and a return loss\footnote{\textit{Return loss} is the loss of signal power due to reflection by a discontinuity in the transmission line.} of about \SI{20}{\decibel} at \SI{50}{\giga \hertz}.\cite{caselle2014}
A photo of the power splitter is shown in \autoref{fig:power_splitter}.

\begin{figure}[tbh]
	\centering
	\includegraphics[width = 0.6\textwidth]{chap/03-currentStat/img/power_splitter}
	\caption{Photo of the power splitter developed at IPE for KAPTURE}
	\label{fig:power_splitter}
\end{figure}

\paragraph{Sampling Board}
The archtiecture of the front-end board with the power splitter is shown in \autoref{fig:kapture}. 
\begin{figure}[tbh]
	\centering
	\includegraphics[width = \textwidth]{chap/03-currentStat/img/kapture.tikz}
	\caption[General architecture of the KAPTURE system]{General architecture of the KAPTURE (v1) front-end sampling card (cf. \cite[p.2]{caselleKAP})}
	\label{fig:kapture}
\end{figure}

Four identical signals from the power-splitter are fed into four channels, consisting of a respective \gls{tha} unit and a 12-bit \gls{adc} sampling at \SI{500}{\mega\sample\per\second}. 
The sampling time of each unit can be adjusted individually with a delay chip with a resolution of \SI{3}{\pico \second} (maximal delay range: \SI{100}{\pico \second}). 
The delay chips are programmed with the \gls{fpga} on the readout card.
The clock signal is provided by \gls{kara}, which is cleared from jitter by a \gls{pll}. 
This ensures the synchronization of the \glspl{adc} with the \gls{rf} system. 
The cleaned clock signal is distributed to the delay chips via fan-out buffer. \cite{caselleKAP}
In this way, the pulse can be "locally sampled" by adjusting the different delay with a maximum rate of 330 GS/s possible. 
A simplified representation of the local sampling of the signal is shown in \autoref{fig:detector_signal}.
\begin{figure}[tbh]
	\centering
	\includegraphics[width = \textwidth, height=0.4\textwidth]{chap/03-currentStat/img/detector_signal.tikz}
	\caption{Signal and sampled points $S_1$ to $S_4$}
	\label{fig:detector_signal}
\end{figure}

\autoref{fig:kapturesys} shows a photo of the system setup at \gls{kara}
\begin{figure}[tbh]
	\centering
	\includegraphics[width = \textwidth]{chap/03-currentStat/img/kapture_sys}
	\caption[Photo of KAPTURE system]{Photo of KAPTURE with highlighted main components. \cite[p.~61]{brosi}}
	\label{fig:kapturesys}
\end{figure}
%todo  re-label



\paragraph{GPU-DAQ System}
In order to manage the large amount of data produced by the sampling system a high-speed \gls{pcie} readout card was developed (called ``High-Flex'').

In order to keep a continuous data  acquisition the necessary bandwidth is 
\begin{equation}
	12 \text{bits} \cdot 8 \, \text{samples} \cdot \SI{500}{\mega \hertz} = 24 \text{Gb/s}
\end{equation}
To ensure high data throughput, the readout board is based on a bus master \gls{dma} architecture which is connected to \gls{pcie} end-point logic. 
This ensures a throughput of up to 2 GByte/s. 
To store the data temporary before it is sent to the \gls{daq} system, a large \gls{ddr}3 memory device is used, as seen in \autoref{fig:kapture}. \cite{caselleKAP}
\begin{figure}[tbh]
	\centering
	\includegraphics[width = \textwidth]{chap/04-work/img/concept_theresa}
	\caption{General concept of the new readout system}
	\label{fig:concept_theresa}
\end{figure}

\subsection{KAPTURE-2}
The first version of \gls{kapture} has a limitation concerning the number of sampling points per pulse and does not allow to sample the baseline of the detector.
Analyzing the baseline however is very important, as it shows a slight change and affects the pulse amplitude of the bunch. 
Due to this distortion, calculating the correlation between bunches was limited. 
For this reason, a second version of \gls{kapture} was designed in order to overcome these limitations. 
The \gls{pll} on the sampling board allows for synchronization between two or more \glspl{pll} located on different boards.
With this feature, the sampling time of two boards can be synchronized and in this way extending the number of sampling points beyond four.
A comparison of the sampling concepts is shown in \autoref{fig:kap1_vs_kap2}.
In \gls{kapture}-2, two front-end boards can be connected to directly sample the pulses with up to eight sampling point at the pulse repetition rate \SI{2}{\GHz}. 
Alternatively, the system can sample the pulse and the baseline between two consecutive pulses with a constant pulse rate up to \SI{1}{\GHz} (see \autoref{fig:kap2}).
In this way, 


\begin{figure}[tbh]
	\centering
	\begin{subfigure}{\textwidth}
		\centering
		\includegraphics[height=0.5\textwidth]{chap/03-currentStat/img/kap1.tikz}  
		\caption{Sampling concept in KAPTURE v1}
		\label{fig:kap1}
	\end{subfigure}
	\begin{subfigure}{\textwidth}
		\centering
		\includegraphics[height=0.5\textwidth]{chap/03-currentStat/img/kap2.tikz}  
		\caption{Sampling concept in KAPTURE v2}
		\label{fig:kap2}
	\end{subfigure}
	\caption{Comparison between the sampling concepts of KAPTURE v1 and KAPTURE v2}
	\label{fig:kap1_vs_kap2}
\end{figure}






\section{Proposed Architecture for THERESA}
In this section the architecture for the \gls{theresa} system is described.
The system consists of the optical time-stretch method, which stretches the analog input signal and the photodetector in order to convert the optical signal into an electrical one.
This signal is sampled by a front-end sampling card, which is mounted on a back-end readout card, which processes the acquired samples.

\subsection*{Optical Part}
For the optical time-stretch setup, a femtosecond Ytterbium-doped fiber laser from MENLO GmbH is used. The emitted pulses have a bandwidth of \SI{50}{\nano \meter} and a total output average power of \SI{40}{\milli \watt}.
The photodetector used is an InGaAs photodiode from \textit{Discovery Semiconductirs} with a \SI{20}{\GHz} bandwidth.

\subsection*{Front-End Sampling Card}
The concept of the front-end sampling card is based on and an evolution of the concept used in the \gls{kapture} system. 
The incoming signal is splitted into 16 identical signals, each leading to the respective sampling channel on the sampling board.
These sampling channels consist of a high bandwidth (\SI{18}{\GHz}), low noise \gls{tha}.
The sampling clock to these \glspl{tha} is provided by respective programmable delay chips.
In this way, a time interleaving technique (described below) can be implemented by programming the delay chips accordingly. 
The main clock is provided by a main \gls{pll}, which cleans the incoming reference clock from the system in which the system is integrated.
\autoref{fig:theresa_scheme} shows the general schema of the sampling system, reduced to four channels for presentation purposes.
\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{chap/04-work/img/theresa_scheme.tikz}
	\caption[General architecture of THERESA]{General architecture of THERESA with power splitter and \glspl{adc}. For presentation purposes only four of the sixteen channels are shown.}
	\label{fig:theresa_scheme}
\end{figure}

\subsubsection*{Time Interleaving}\label{sssec:time-interleaving}
In order to increase the sampling rate, the so called time-interleaving technique is used. In this section, first basic theory about this technique is given. Then, the implementation in the new system is described.

\paragraph{Theory}
In the \textit{Time Interleaving} technique multiple \glspl{adc} are used in such way, that allows to sample data at a faster rate, than the respective sample rate of each individual \gls{adc}. 
The principle is based on time-multiplexing an array of $M$ identical \glspl{adc} (see \autoref{fig:adcInter}), each sampling at $f_c = f_s/M$ individually. This means, the \glspl{adc} are clocked in such a way, that they start their respective conversion cycle shortly one after another. 
At time $t_0$ the first \gls{adc} starts converting the input signal $V_i(t_0)$, after a time delay $\Delta t_i$ the second starts converting the signal $V_i(t_0 + t_i)$, the third converts $V_i(t_0 + 2t_i)$ and so on. 
After the $M$-th \gls{adc} has sampled the signal $V_i(t_0 + (M-1)t_i)$, the whole cycle starts anew with the first converter. \cite{mangrob}
An example for such a cyle for 4 \glspl{adc} is shown in \autoref{fig:adcInterTime}.

\begin{figure}[tbh]
	\centering
	\begin{subfigure}{\textwidth}
		\centering
		\includegraphics[width=0.8\textwidth]{chap/04-work/img/adcInter.tikz}  
		\caption{An array of $M$ time interleaved $N$-bit \glspl{adc} \cite{mangrob}}
		\label{fig:adcInter}
	\end{subfigure}
	\vspace*{2ex}
	\begin{subfigure}{\textwidth}
		\centering
		\tikzexternaldisable
		\includegraphics[width=\textwidth]{chap/04-work/img/adcInterTime.tikz}  
		\caption{Clocking Scheme for interleaving 4 \glspl{adc}}
		\tikzexternalenable
		\label{fig:adcInterTime}
	\end{subfigure}
	\caption[Time-Interleaving Method]{Array of $M$ time interleaved \glspl{adc} and clocking example for $M = 4$}
	\label{fig:interleaving}
\end{figure}
\paragraph{Challenges}
Spurs appear in the spectrum. There are several reasons for this.

First reason is the \textit{offset mismatch} between den \glspl{adc}. 
Each \gls{adc} has an DC offset value. Considering as example an interleaving structure with two \glspl{adc} and a constant input voltage: when the samples are acquired back and forth between the two \glspl{adc}, the resulting output will switch back and forth between two levels due to the different offset levels. 
This output switches at the frequency $f_s/2$ and therefore introduces an additional frequency component in the spectrum (see \autoref{fig:offset_mm}). 
The magnitude of the spur depends on the offset difference between the \glspl{adc}. \cite{Harris2019}

\begin{figure}[tbh]
	\centering
	\includegraphics[width = \textwidth]{chap/02-theory/img/offset_mm}
	\caption{Placeholder: Offset-Mismatch in Interleaving \cite{Harris2019}}
	\label{fig:offset_mm}
\end{figure}

Besides of the offset also the gain of the converters can be mismatched. 
This \textit{gain mismatch} has a frequency component to it, which in case of an input signal of the frequency $f_{\text{in}}$ results in a spur at $f_s/2 \pm f_{\text{in}}$ (see \autoref{fig:gain_mm}). \cite{Harris2019}

\begin{figure}[tbh]
	\centering
	\includegraphics[width = \textwidth]{chap/02-theory/img/gain_mm}
	\caption{Placeholder: Gain-Mismatch in Interleaving \cite{Harris2019}}
	\label{fig:gain_mm}
\end{figure}

In the time domain, \textit{timing mismatch} due to group delay in the analog circuitry of the \gls{adc} and clock skew\footnote{Difference in arrival time of the clock signal at different components.} can occur. 
The group delay in analog circuitry can vary between the converters. 
Furthermore, the clock skew has on the one hand an aperture uncertainty component at each of the \glspl{adc} and on the other hand a component related to the accuracy of the clock phases, which are input to each converter. \cite{Harris2019} 
This mismatch also produces a spur at $f_s/2 \pm f_{\text{in}}$ (see \autoref{fig:timing_mm}).

\begin{figure}[tbh]
	\centering
	\includegraphics[width = \textwidth]{chap/02-theory/img/timing_mm}
	\caption{Placeholder: Timing-Mismatch in Interleaving \cite{Harris2019}}
	\label{fig:timing_mm}
\end{figure}

The last possible mismatch is the \textit{bandwidth mismatch}, which contains both gain and phase/frequency component (see \autoref{fig:bandwidth_mm}). 
Due to bandwidth mismatch, different gain values at different frequencies can be seen. 
An additional timing component causes different delays for signals at different frequencies through each \gls{adc}. 
Just like gain and timing mismatch, the bandwidth mismatch causes a spur at $f_s/2 \pm f_{\text{in}}$.
\begin{figure}[tbh]
	\centering
	\includegraphics[width = \textwidth]{chap/02-theory/img/bandwidth_mm}
	\caption{Placeholder: Timing-Mismatch in Interleaving \cite{Harris2019}}
	\label{fig:bandwidth_mm}
\end{figure}

\paragraph{Implementation}\label{ssec:interl_impl}
The delay step size must be small enough, such that the \gls{adc} interleaving technique \autoref{sssec:time-interleaving} can be implemented.
The \glspl{adc} on the read-out card sample at a maximal sample rate of \SI{2.5}{\giga \sample \per \second}, meaning during the time
\begin{equation}
	t_s = \frac{1}{\SI{2.5}{\giga \sample \per \second}} = \SI{400}{\pico \second}
\end{equation}
all 16 \glspl{adc} have to be clocked one time.
This means, a delay step can not be greater than $\nicefrac{\SI{400}{\pico\second}}{16} = \SI{25}{\pico\second}$.

Clock to THA: \SI{2}{\GHz}
$\rightarrow$ Step size for delay:
\begin{equation}
	\frac{\SI{1}{\nano \second}}{16 \, \text{channels}} = \SI{62.5}{\pico \second}
\end{equation}

Aperture delay, jitter, need to be taken into account to determine the max. sampling frequency.

\begin{sidewaysfigure}[tbh]
	\centering
	\tikzexternaldisable
	\includegraphics[width = 0.8\textwidth]{chap/04-work/img/interl_timing}
	\tikzexternalenable
	\caption[Track-And-Hold Timing diagram]{\gls{tha} Timing diagram. Shows the clocking of the \gls{tha} (HIGH = hold mode, LOW = track mode). Dashed line represents the sampling of the \gls{adc}.}
	\label{fig:THA}
\end{sidewaysfigure}

The necessary step size for the delay chips, when using 16 ADC@\SI{2}{\giga \sample \per \second} in time-interleaving mode, is: $\frac{\SI{2}{\giga \sample \per \second}}{16} = \SI{31}{\pico \second}$
However, providing individual clocks to the ADCs is not possible on the ZCU216 card. 
ADCs are grouped together into tiles, each tile containing four converters. One single reference clock signal is propagated to all tiles. 
Sampling clock is adjusted at each tile individually, however this clocking signal is the same for all of the four converters in the tile. 
Normally, only one reference clock can be provided. 
Analyzing the schematic of the ZCU216 board revealed however, that there are pins leading to the FPGA banks (224 to 227), labeled as clocks for the individual tiles. 
Two of the clocks are not connected (224 and 227). 225 is provided via SMA cable, the other comes from the LPAM clock connector. 

\subsection*{Readout Card}
\textbf{TODO}
\subsubsection*{Selection Of The Card}\label{sec:selection}
When selecting the Readout Card, following criteria need to be considered:
\begin{itemize}
	\item Integrated \glspl{adc}
	\item Number, resolution and bandwidth of \glspl{adc}
	\item Peripheral connections
	\item Flexibility/Customization
	\item Suitable connectivity for high-data-throughput
\end{itemize}

Footprint of using all discrete components is, as one can imagine, higher, than if you integrate all the parts into on \gls{ic}. 
Not only the footprint is a concern, but also the number of connections. 
ADCs with high resolution, a high number of ADCs therefore explodes the necessary amount of connections. 

With the data converters integrated directly into the \gls{fpga} using parallel interfaces, they do not require the
prohibitively high-pin-count external connections needed for discrete parallel interface converters.
 
\begin{figure}[tbh]
	\centering
	\includegraphics[width = \textwidth]{chap/04-work/img/footprint}
	\caption{Placeholder: Discrete vs IC}
	\label{fig:footprint}
\end{figure}
