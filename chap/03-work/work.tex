This chapter covers the architecture and design of the system.
\section{General architecture}
In this section the general architecture of the THERESA system is described.
The idea for the new system is to reuse the concept of the already existing sampling system KAPTURE (\textbf{Ka}rlsruhe \textbf{P}ulse \textbf{T}aking \textbf{U}ltra-fast \textbf{R}eadout \textbf{E}lectronics), which is using four ADCs, and expanding it to 16. Therefore, also the architecture of the latter is explained briefly.
\subsection{KAPTURE-2}
KAPTURE, which was developed at IPE, is a system designed to continuously sample ultra-short pulses generated by Terahertz detectors. It consists of a daughter card, holding four sampling channels, mounted on a FPGA . The FPGA is connected to a computer via PCIe for further processing of the acquired data. \cite{brosi} 
The newer version, KAPTURE-2, was designed for more accurate sampling for pulse repetition rates up to \SI{2}{\giga \hertz}. The acquired data is processed with a FPGA and GPU architecture.  \cite{caselleKAP}

The general structure of the board is shown in \autoref{fig:kapture}.

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{chap/03-work/img/kapture.tikz}
	\caption{General schema of KAPTURE-2 (cf. \cite[p.2]{caselleKAP})}
	\label{fig:kapture}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[height = 0.3\textwidth, width = 0.6\textwidth]{chap/03-work/img/pll_karaMode.tikz}
	\caption{}
	\label{fig:pll}
\end{figure}

The pulse from the \SI{}{\tera \hertz} detector is fed into a power splitter, which splits the signal into four identical pulses and distributes them to four channels, consisting of a respective Track-And-Hold-Amplifier (THA) unit and a 12-bit ADC@\SI{500}{\mega\sample\per\second}. The sampling time of each unit can be adjusted individually with a Picosecond Delay Chip with a resolution of \SI{3}{\pico \second} (maximal delay range: \SI{100}{\pico \second}). 
The clock signal is provided by KARA, which cleared from jitter by a Phase-Locked-Loop (PLL). This ensures the synchronization of the ADCs with the RF system. The clean clock signal is distributed to the delay chips via fan-out. \cite{caselleKAP}

The resulting sampling of the detector signal is shown \autoref{fig:detector_signal} (simplified representation).
\begin{figure}[H]
	\centering
	\includegraphics[height = 0.3\textwidth, width = 0.6\textwidth]{chap/03-work/img/detector_signal.tikz}
	\caption{Signal with sample points}
	\label{fig:detector_signal}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width = 0.8\textwidth]{chap/03-work/img/kapture_sys.png}
	\caption{Photo of KAPTURE with highlighted main components. \cite[p.~61]{brosi}}
	\label{fig:kapturesys}
\end{figure}

\newpage
\subsection{THERESA}
In principle, the new system has the same structure, as KAPTURE. Notable differences are firstly the number of ADCs, which is increased up to 16. Secondly, the latter are not located on the daughter card anymore, but inside the Xilinx Zynq UltraScale+ RFSoC ZU49DR on the ZCU216 Evaluation Kit on which the front-end card is mounted. \autoref{fig:theresa_scheme} shows the general schema of the sampling system, reduced to four channels for presentation purposes.
\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{chap/03-work/img/theresa_scheme.tikz}
	\caption{General schema of THERESA. For presentation purposes only four channels are shown.}
	\label{fig:theresa_scheme}
\end{figure}

\subsubsection{Xilinx Zynq UltraScale+ RFSoC ZCU216 Evaluation Kit}
The card, holding the sampling channels, should be mounted on a ZCU216 evaluation board. This board is the newest generation of Xilinx' evaluation cards, which has features suitable for the purpose at hand.
\begin{itemize}
\item Sixteen 14-bit, 2.5GSPS RF-ADC
\item Sixteen 14-bit, 10GSPS RF-DAC
\item I/O expansion options â€“ FPGA Mezzanine Card (FMC+) interfaces, RFMC 2.0 interfaces, and Pmod connections
\end{itemize}
\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{chap/03-work/img/zcu216.png}
	\caption{ZCU216 evaluation board}
	\label{fig:zcu216}
\end{figure}
 
\begin{figure}[H]
	\centering
	\includegraphics[width = 0.6\textwidth]{chap/03-work/img/rfsoc_blockdiagram.png}
	\caption{RFSoC block diagram}
	\label{fig:rfsoc}
\end{figure}

\subsection{Requirements}
\paragraph{Step size delay chip}
The necessary step size for the delay chips, when using 16 ADC@\SI{2}{\giga \sample \per \second} in time-interleaving mode, is: $\frac{\SI{2}{\giga \sample \per \second}}{16} = \SI{31}{\pico \second}$

\paragraph{Frequency}


\begin{figure}[H]
\centering
\tikzexternaldisable
\begin{tikztimingtable}
  TH1 & 1H 8L N(A1) 8L 16H \\
  TH2 & 2H 16L 15H \\
  TH3 & 3H 16L 14H \\
  TH4 & 4H 5L N(B1) 11L 13H \\
  \\
  TH5 & 5H 16L 12H \\
  TH6 & 6H 16L 11H \\
  TH7 & 7H 16L 10H \\
  TH8 & 8H 16L 9H \\
  \\
  TH9 & 9H 16L 8H \\
  TH10 & 10H 16L 7H \\
  TH11 & 11H 16L 6H \\
  TH12 & 12H 16L 5H \\
  \\
  TH13 & 13H 16L 4H \\
  TH14 & 14H 16L 3H \\
  TH15 & 15H 16L 2H \\
  TH16 & 16H 16L 1H \\
\extracode
 \tablerules
 \begin{pgfonlayer}{background}
 \draw [help lines] (A1) -- (B1);
 \end{pgfonlayer}
\end{tikztimingtable}
\tikzexternalenable
\caption{Track-And-Hold Timing diagram}
\label{fig:THA}
\end{figure}




\paragraph{Data Rate}
\paragraph{Visualization/GUI}
\newpage
\section{Design of the front-end card}
In this section, the design of the front-end card is covered.

\subsection{Sampling-Channel}
\paragraph{Delay Chip NB6L295}
Dual Channel Programmable Delay Chip.

\begin{itemize}
	\item Two individual variable delay channels
	\item Dual Delay: minimal delay \SI{3.2}{\nano \second}
	\item Total Delay Range: \SI{3.2}{\nano \second} to \SI{8.8}{\nano \second} per Delay Channel
	\item \SI{11}{\pico \second} Increments in 511 steps
	\item \SI{100}{\pico \second} Typical Rise and Fall Times
\end{itemize}

\subsection{Clocking}
\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{chap/03-work/img/clk104.png}
	\caption{CLK104 Add-on board clocking scheme}
	\label{fig:clk104}
\end{figure}

%\begin{figure}[H]
%	\centering
%	\includegraphics[height = 0.3\textwidth, width = 0.55\textwidth]{chap/03-work/img/pll_tsMode.tikz}
%	\caption{Clocking scheme on front-end card}
%	\label{fig:pll}
%\end{figure}


\subsection{Power Supply}
For the Track-And-Hold amplifiers a new power supply unit -- the ADP1741 (Analog Devices) -- should be used. It is necessary to think about the amount of power supply chips needed. As a rule of thumb, the power supply should provide twice the maximum power needed by the components it drives. The power consumption/maximum current for the respective components on the THERESA board is listed in \autoref{tab:kapturecomp}. 
\begin{table}[tbh!]
	\caption{Power consumption of components on the board}
	\label{tab:kapturecomp}
	\begin{minipage}{\textwidth}
		\centering
		\begin{tabularx}{\textwidth}{XSSSSS}
			\toprule
			\textbf{Component} & \textbf{$V_{cc}$ (\SI{}{\volt})} & \textbf{$I_{max}$ (\SI{}{\ampere})} & \textbf{$P_{max}$ (\SI{}{\watt})} & $\#_{parts}$ & \textbf{$I_{tot}$}\footnote{for 16 ADCs} (\SI{}{\ampere})\\
				\midrule
			HMC5649 (T/H-Amplifier) 	& 2	  	& 0.221 	 & 0.442 & 16 & 3.536\\
									& -5  	& -0.242 & 1.21 &  & 3.872\\
			HMC856 (Delay) 			& -3.3	& 0.185 & -0.611 & 16 & 2.96\\
			HMC987LP5E (Fan-Out) 	& 3.3 	& 0.234\footnote{All Outputs and RF-Buffer} & 0.772 & 2 & 0.468\\
			LMC0480 (PLL) 			& 3.3 	& 0.590\footnote{All CLKs} & 1.947 & 1 & 0.590\\
			VCXO 					& 3.3 	& 0.03 & 0.198 & 1 & 0.03\\
			\bottomrule
		\end{tabularx}
	\end{minipage}
\end{table}

The maximal current which the ADP1741 can provide @\SI{2}{\volt} is \SI{2}{\ampere}. This means, with one Track-And-Hold amplifier requiring a maximal current of \SI{0.221}{\ampere}, one ADP1741 can handle four units according to the rule mentioned beforehand ($I_{max\_ADP1741} = \SI{2}{\ampere} > 2 * I_{tot}, I_{tot} = 4 \times \SI{0.221}{\ampere} =  \SI{0.884}{\ampere}$).



\newpage
\section{PCB-Layout}
\subsection{General Techniques/Strategies?}
\subsection{Floor Planning}
\subsection{Transmission lines}



\paragraph{Surface Coplanar Waveguide with Ground}  
    \begin{figure}[!htbp]
        \centering
        \begin{tikzpicture}
            \filldraw[color=black, fill=black] (0,0.7) rectangle ++(9,0.3) node[pos=.5](gnd){};
            \filldraw[color=black, fill=gray!20] (0,1) rectangle ++(9,2) node[pos=.5]{\(\varepsilon_r\)};
            \filldraw[color=black, fill=black] (0,3) rectangle ++(2,.2) node[pos=.5](GND1){};
            \filldraw[color=black, fill=black] (3,3) rectangle ++(1,.2) node[pos=.5](cond1){};
            \filldraw[color=black, fill=black] (5,3) rectangle ++(1,.2) node[pos=.5](cond2){};
            \filldraw[color=black, fill=black] (7,3) rectangle ++(2,.2) node[pos=.5](GND2){};
            \draw[>=triangle 45, <->] (-0.5,1) -- (-0.5,3) node[pos=.5,anchor=west](){\(h\)};
            \draw[>=triangle 45, <->] (2,4) -- ++(1,0) node[pos=.5,anchor=south](){\(d\)};
            \draw[>=triangle 45, <->] (3,3.8) -- ++(1,0) node[pos=.5,anchor=south](){\(w\)};
            \draw[>=triangle 45, <->] (4,3.6) -- ++(1,0) node[pos=.5,anchor=south](){\(s\)};
            %\draw[>=triangle 45,  <->] (5.7,3) -- ++(0,0.2) node[pos=.5,anchor=west](){\(t\)};
            
            \draw[dashed] (9,3.2) -- (10,3.2);
            \draw[dashed] (9,3) -- (10,3);
            \draw[dashed] (0,1) -- (-1,1);
            \draw[dashed] (0,3) -- (-1,3);
            
            \draw[>=triangle 45, <->] (-0.5,1) -- (-0.5,3) node[pos=.5,anchor=west](){\(h\)};
            \draw[>=triangle 45, ->] (10,4) -- (10,3.2) node[pos=.5,anchor=west](){\(t\)};
            \draw[>=triangle 45, ->] (10,2.2) -- (10,3) node[pos=.5,anchor=west](){};
            
        \end{tikzpicture}
        \caption{Edge-Coupled Coplanar Waveguide}
        \label{fig:microstrip_geometry}
    \end{figure}
    
The corresponding equations are \cite[~p197-198]{wadell}: 
\begin{equation}
Z_{0,o} = \frac{\eta_0}{\sqrt{\epsilon_{eff,o}}} \left( \frac{1.0}{2.0 \frac{K(k_o)}{K'(k_o)} + \frac{K(\beta_1)}{K'(\beta_1)}}\right)
\end{equation}    

\begin{equation}
Z_{0,e} = \frac{\eta_0}{\sqrt{\epsilon_{eff,e}}} \left( \frac{1.0}{2.0 \frac{K(k_e)}{K'(k_e)} + \frac{K(\beta_1 k_1)}{K'(\beta_1 k_1)}}\right)
\end{equation} 


\begin{equation}
\epsilon_{eff,o} = \frac{2.0 \epsilon_r \frac{K(k_o)}{K'(k_o)} + \frac{K(\beta_1)}{K'(\beta_1)}}{2.0 \frac{K(k_o)}{K'(k_o)} + \frac{K(\beta_1)}{K'(\beta_1)}}
\end{equation}

\begin{equation}
\epsilon_{eff,e} = \frac{2.0 \epsilon_r \frac{K(k_e)}{K'(k_e)} + \frac{K(\beta_1 k_1)}{K'(\beta_1 k_1)}}{2.0 \frac{K(k_e)}{K'(k_e)} + \frac{K(\beta_1 k_1)}{K'(\beta_1 k_1)}}
\end{equation}

Where

\begin{equation}
k_o = \Lambda \frac{-\sqrt{\Lambda^2 - t_c^2} + \sqrt{\Lambda^2 - t_B^2}}{t_B\sqrt{\Lambda^2 - t_c^2} + t_c \sqrt{\Lambda^2 - t_B^2}}
\end{equation}

\begin{equation}
k_e = \Lambda' \frac{-\sqrt{\Lambda'^2 - t_c'^2} + \sqrt{\Lambda'^2 - t_B'^2}}{t_B'\sqrt{\Lambda'^2 - t_c'^2} + t_c' \sqrt{\Lambda'^2 - t_B'^2}}
\end{equation}
    
    
\begin{equation}
\Lambda = \frac{\sinh^2 \left( \frac{\pi (s/2.0 + w + d)}{2.0 h} \right) }{2}
\end{equation}

\begin{equation}
t_c = \sinh^2 \left( \frac{\pi (s/2.0 + w)}{2.0 h} \right) - \Lambda
\end{equation}

\begin{equation}
t_B = \sinh^2 \left( \frac{\pi s}{4.0 h} \right) - \Lambda
\end{equation}


\begin{equation}
\Lambda' = \frac{\cosh^2 \left( \frac{\pi (s/2.0 + w + d)}{2.0 h} \right) }{2}
\end{equation}

\begin{equation}
t_c' = \sinh^2 \left( \frac{\pi (s/2.0 + w)}{2.0 h} \right) - \Lambda' + 1.0
\end{equation}

\begin{equation}
t_B' = \sinh^2 \left( \frac{\pi s}{4.0 h} \right) - \Lambda + 1.0
\end{equation}

The parameters have to be chosen according to 
\begin{equation}
s + 2.0 w + 2.0 d \leq h
\end{equation}
to guarantee coplanar propagation. \cite{wadell}
    
\paragraph{Surface Coplanar Waveguide with Ground}  
  
\begin{figure}[!htbp]
     \centering
     \begin{tikzpicture}
            \filldraw[color=black, fill=black] (0,0.7) rectangle ++(9,0.3) node[pos=.5](gnd){};
            \filldraw[color=black, fill=gray!20] (0,1) rectangle ++(9,2) node[pos=.5]{\(\varepsilon_r\)};
            \filldraw[color=black, fill=black] (0,3) rectangle ++(2,.2) node[pos=.5](GND1){};
            \filldraw[color=black, fill=black] (3.5,3) rectangle ++(2,.2) node[pos=.5](cond1){};
            \filldraw[color=black, fill=black] (7,3) rectangle ++(2,.2) node[pos=.5](GND2){};
            \draw[>=triangle 45, <->] (3.5,3.4) -- ++(2,0) node[pos=.5,anchor=south](){\(a\)};
            \draw[>=triangle 45, <->] (2,3.8) -- ++(5,0) node[pos=.5,anchor=south](){\(b\)};
            
            
            \draw[dashed] (9,3.2) -- (10,3.2);
            \draw[dashed] (9,3) -- (10,3);
            \draw[dashed] (0,1) -- (-1,1);
            \draw[dashed] (0,3) -- (-1,3);
            
            \draw[>=triangle 45, <->] (-0.5,1) -- (-0.5,3) node[pos=.5,anchor=west](){\(h\)};
            \draw[>=triangle 45, ->] (10,4) -- (10,3.2) node[pos=.5,anchor=west](){\(t\)};
            \draw[>=triangle 45, ->] (10,2.2) -- (10,3) node[pos=.5,anchor=west](){};
            %\draw[>=triangle 45,  <->] (5.7,3) -- ++(0,0.2) node[pos=.5,anchor=west](){\(t\)};
        \end{tikzpicture}
        \caption{Coplanar Waveguide with Ground}
        \label{fig:microstrip_geometry}
    \end{figure}
    
    
  The characteristic impedance of a coplanar waveguide is given as follows \cite{wadell}: 
  \begin{equation}
  Z_0 = \frac{60.0 \pi}{\sqrt{\epsilon_{eff}}} \frac{1.0}{\frac{K(k)}{K(k')} + \frac{K(k_1)}{K(k_1')}}
  \end{equation}
  It comprises of the following components, with K(k) being an elliptical integral of the first kind (see also \cite[p.~430]{bronstein}):
  \begin{equation}
  k = a/b
  \end{equation}
  \begin{equation}
  k' = \sqrt{1.0 - k^{2}}
  \end{equation}
  \begin{equation}
  k_1' = \sqrt{1.0 - k_1^{2}}
  \end{equation}
  \begin{equation}
  k_1 = \frac{tanh(\frac{\pi a}{4.0  h})}{tanh(\frac{\pi  b}{4.0 h})}
  \end{equation}
  \begin{equation}
  \epsilon_{eff} = \frac{1.0 + \epsilon_r \frac{K(k')}{K(k)} \frac{K(k_1)}{K(k_1')}}{1.0 + \frac{K(k')}{K(k)} \frac{K(k_1)}{K(k_1')}}
  \end{equation}
  
\subsection{Polaris}


\begin{figure}[H]
	\centering
	\includegraphics[width = 0.8\textwidth]{chap/03-work/img/polaris.png}
	\caption{Polaris Solver}
	\label{fig:polaris}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth, height = 0.5\textwidth]{chap/03-work/img/megtron_diff_bottom_d1_vs_s1.tikz}
	\caption{Test Graph}
	\label{fig:megtron}
\end{figure}

  
\newpage
\section{Firmware}
\subsection{Xilinx Designs}
\subsection{SPI-firmware for components}
\subsection{IPE-AXI IP block}
\subsection{GUI}





