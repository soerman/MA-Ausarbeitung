This chapter covers the architecture and design of the system.
\section{General architecture}
In this section the general architecture of the \gls{theresa} system is described.
The idea for the new system is to reuse the concept of the already existing sampling system \gls{kapture}, which is using four \glspl{adc}, and expanding it to 16. Therefore, also the architecture of the latter is explained briefly.
\subsection{KAPTURE-2}
\Gls{kapture}, developed at \gls{ipe}, is a system designed to continuously sample ultra-short pulses generated by Terahertz detectors. %todo numbers? maybe state the one time in the introduction
It consists of a daughter card, holding four sampling channels, mounted on a \gls{fpga}. The \gls{fpga} is connected to a computer via \gls{pcie} for further processing of the acquired data. \cite{brosi}
%todo where does the daughter card go? maybe explain it top to bottom?
%todo can you 'touch' the sampling channels? maybe say circuits or adcs, or...
The newer version, KAPTURE-2, was designed for more accurate sampling for pulse repetition rates up to \SI{2}{\giga \hertz}. The acquired data is processed with a \gls{fpga} and GPU architecture.  \cite{caselleKAP}

The general structure of the board is shown in \autoref{fig:kapture}.
%todo what is THE board?

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{chap/03-work/img/kapture.tikz}
	\caption{General schema of KAPTURE-2 (cf. \cite[p.2]{caselleKAP})}
	\label{fig:kapture}
\end{figure}


The pulse from the \gls{thz} detector is fed into a power splitter, which splits the signal into four identical pulses and distributes them to four channels, consisting of a respective \gls{tha} unit and a 12-bit \gls{adc} sampling at \SI{500}{\mega\sample\per\second}. The sampling time of each unit can be adjusted individually with a Picosecond Delay Chip with a resolution of \SI{3}{\pico \second} (maximal delay range: \SI{100}{\pico \second}). %todo Picosecond Delay Chip. is a PDS a known chip or sth?
The clock signal is provided by \gls{kara}, which is cleared from jitter by a \gls{pll}. This ensures the synchronization of the \glspl{adc} with the \gls{rf} system. The cleaned clock signal is distributed to the delay chips via fan-out. \cite{caselleKAP}
%todo fan-out? like F9? maybe 'fan-out circuit' or sth else

The resulting sampling of the detector signal is shown \autoref{fig:detector_signal} (simplified representation).
%todo what are the S_i?
\begin{figure}[H]
	\centering
	\includegraphics[height = 0.3\textwidth, width = 0.6\textwidth]{chap/03-work/img/detector_signal.tikz}
	\caption{Signal with sample points}
	\label{fig:detector_signal}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{chap/03-work/img/kapture_sys}
	\caption{Photo of KAPTURE with highlighted main components. \cite[p.~61]{brosi}}
	\label{fig:kapturesys}
\end{figure}
%todo 1\textwidth and re-label

\newpage
\subsection{New System THERESA}
In principle, the new system has the same structure, as \gls{kapture}. Notable differences are firstly the number of \glspl{adc}, which is increased up to 16. Secondly, the latter are not located on the daughter card anymore, but inside the Xilinx Zynq UltraScale+ RFSoC ZU49DR on the ZCU216 Evaluation Kit on which the front-end card is mounted.
%todo On THE xyz board? do we know what this is at this point?
\autoref{fig:theresa_scheme} shows the general schema of the sampling system, reduced to four channels for presentation purposes.
\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{chap/03-work/img/theresa_scheme.tikz}
	\caption{General schema of THERESA. For presentation purposes only four channels are shown.}
	\label{fig:theresa_scheme}
\end{figure}

\paragraph{Xilinx Zynq UltraScale+ RFSoC ZCU216 Evaluation Card}

Zynq UltraScale+ RFSoCs: Combine RF data converter subsystem and forward error correction with industry-leading
programmable logic and heterogeneous processing capability. Integrated RF-ADCs, RF-DACs, and soft decision FECs (SD-FEC)
provide the key subsystems for multiband, multi-mode cellular radios and cable infrastructure


The card, holding the sampling channels, should be mounted on a ZCU216 evaluation board. This board is the newest generation of Xilinx' evaluation cards, which has features suitable for the purpose at hand.
\begin{itemize}[noitemsep]
\item Sixteen 14-bit, 2.5GSPS RF-ADC
\item Sixteen 14-bit, 10GSPS RF-DAC
\item I/O expansion options â€“ FPGA Mezzanine Card (FMC+) interfaces, RFMC 2.0 interfaces, and Pmod connections
\end{itemize}
\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{chap/03-work/img/zcu216}
	\caption{ZCU216 evaluation board}
	\label{fig:zcu216}
\end{figure}
 
\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth]{chap/03-work/img/rfsoc_blockdiagram}
	\caption{RFSoC block diagram}
	\label{fig:rfsoc}
\end{figure}

\subsection{Requirements}
\paragraph{Interleaving}
The necessary step size for the delay chips, when using 16 ADC@\SI{2}{\giga \sample \per \second} in time-interleaving mode, is: $\frac{\SI{2}{\giga \sample \per \second}}{16} = \SI{31}{\pico \second}$
However, providing individual clocks to the ADCs is not possible on the ZCU216 card. ADCs are grouped together into tiles, each tile containing four converters. One single reference clock signal is propagated to all tiles. Sampling clock is adjusted at each tile individually, however this clocking signal is the same for all of the four converters in the tile.

Clock to THA: \SI{500}{\mega \hertz}

Total Hold time: \SI{1}{\nano \second}

$\rightarrow$ Step size for delay:
\begin{equation}
	\frac{\SI{1}{\nano \second}}{16 \, \text{channels}} = \SI{62.5}{\pico \second}
\end{equation}

\begin{figure}[H]
\centering
\tikzexternaldisable
\begin{tikztimingtable}
  TH1 & 1L 8H N(A1) 8H 16L \\
  TH2 & 2L 16H 15L \\
  TH3 & 3L 16H 14L \\
  TH4 & 4L 5H N(B1) 11H 13L \\
  \\
  TH5 & 5L 16H 12L \\
  TH6 & 6L 16H 11L \\
  TH7 & 7L 16H 10L \\
  TH8 & 8L 16H 9L \\
  \\
  TH9 & 9L 16H 8L \\
  TH10 & 10L 16H 7L \\
  TH11 & 11L 16H 6L \\
  TH12 & 12L 16H 5L \\
  \\
  TH13 & 13L 16H 4L \\
  TH14 & 14L 16H 3L \\
  TH15 & 15L 16H 2L \\
  TH16 & 16L 16H 1L \\
\extracode
 \tablerules
 \begin{pgfonlayer}{background}
 \draw [help lines, dashed] (A1) -- (B1);
 \end{pgfonlayer}
\end{tikztimingtable}
\tikzexternalenable
\caption{Track-And-Hold Timing diagram}
\label{fig:THA}
\end{figure}
%todo what does the dashed line show?




\paragraph{Data Rate}

ADC samples \@ \SI{2.5}{\giga \hertz} with 14-bit resolution.

\paragraph{Visualization/GUI}
\newpage
\section{Design of the front-end card}
In this section, the design of the front-end card is covered.

\subsection{Sampling-Channel}
\paragraph{Track-And-Hold-Amplifier}
Explain why better than Sample-And-Hold-Amplifier.
\paragraph{Delay Chip NB6L295}
Dual Channel Programmable Delay Chip.

\begin{itemize}[noitemsep]
	\item Two individual variable delay channels
	\item Dual Delay: minimal delay \SI{3.2}{\nano \second}
	\item Total Delay Range: \SI{3.2}{\nano \second} to \SI{8.8}{\nano \second} per Delay Channel
	\item \SI{11}{\pico \second} Increments in 511 steps
	\item \SI{100}{\pico \second} Typical Rise and Fall Times
\end{itemize}

\subsection{Clocking}
On Xilinx CLK104 add-on board the LMX2594 is used to generate additional, high-frequency clocks for the ADCs/DACs. $\rightarrow$ reuse in front-end card
\begin{figure}[H]
	\centering
	\includegraphics[width = 0.7\textwidth]{chap/03-work/img/clk104}
	\caption{CLK104 Add-on board clocking scheme}
	\label{fig:clk104}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[height = 0.3\textwidth, width = 0.55\textwidth]{chap/03-work/img/pll_tsMode.tikz}
	\caption{Clocking scheme on front-end card}
	\label{fig:clocking}
\end{figure}


\begin{figure}[H]
	\centering
	\includegraphics[width = 0.7\textwidth]{chap/03-work/img/pll.png}
	\caption{Placeholder}
	\label{fig:pll}
\end{figure}



\subsection{Power Supply}
For the Track-And-Hold amplifiers a new power supply unit -- the ADP1741 (Analog Devices) -- should be used. It is necessary to think about the amount of power supply chips needed. As a rule of thumb, the power supply should provide twice the maximum power needed by the components it drives. The power consumption/maximum current for the respective components on the THERESA board is listed in \autoref{tab:kapturecomp}. 
\begin{table}[tbh!]
	\caption{Power consumption of components on the board}
	\label{tab:kapturecomp}
	\begin{minipage}{\textwidth}
		\centering
		\begin{tabularx}{\textwidth}{XSSSSS}
			\toprule
			\textbf{Component} & \textbf{$V_{cc}$ (\SI{}{\volt})} & \textbf{$I_{max}$ (\SI{}{\ampere})} & \textbf{$P_{max}$ (\SI{}{\watt})} & $\#_{parts}$ & \textbf{$I_{tot}$}\footnote{for 16 ADCs} (\SI{}{\ampere})\\
				\midrule
			HMC5649 (T/H-Amplifier) 	& 2	  	& 0.221 	 & 0.442 & 16 & 3.536\\
									& -5  	& -0.242 & 1.21 &  & 3.872\\
			HMC856 (Delay) 			& -3.3	& 0.185 & -0.611 & 16 & 2.96\\
			HMC987LP5E (Fan-Out) 	& 3.3 	& 0.234\footnote{All Outputs and RF-Buffer} & 0.772 & 2 & 0.468\\
			LMC0480 (PLL) 			& 3.3 	& 0.590\footnote{All CLKs} & 1.947 & 1 & 0.590\\
			VCXO 					& 3.3 	& 0.03 & 0.198 & 1 & 0.03\\
			\bottomrule
		\end{tabularx}
	\end{minipage}
\end{table}

The maximal current which the ADP1741 can provide @\SI{2}{\volt} is \SI{2}{\ampere}. This means, with one Track-And-Hold amplifier requiring a maximal current of \SI{0.221}{\ampere}, one ADP1741 can handle four units according to the rule mentioned beforehand ($I_{max\_ADP1741} = \SI{2}{\ampere} > 2 * I_{tot}, I_{tot} = 4 \times \SI{0.221}{\ampere} =  \SI{0.884}{\ampere}$).



\newpage
\section{PCB-Layout}
\subsection{Floor Planning}
\subsection{Transmission lines}

\begin{figure}[H]
	\centering
	\includegraphics[width = 0.8\textwidth]{chap/03-work/img/polaris}
	\caption{Polaris Solver}
	\label{fig:polaris}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width = \textwidth, height = 0.5\textwidth]{chap/03-work/img/megtron_diff_bottom_d1_vs_s1.tikz}
	\caption{Test Graph}
	\label{fig:megtron}
\end{figure}

  
\newpage
\section{Firmware}
\subsection{General Design}
\subsubsection{Firmware for Front-End Card}
\paragraph{Clocking}
\paragraph{SPI-Interface}
\subsubsection{Data Capture}
\begin{figure}[H]
	\centering
	\includegraphics[width = 0.8\textwidth]{chap/03-work/img/adc_cap}
	\caption{Placeholder}
	\label{fig:adccap}
\end{figure}

\subsubsection{Visualization}





